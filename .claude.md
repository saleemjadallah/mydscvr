# MyDscvr Backend - Developer Guide

## Stripe & Subscription Configuration

### Overview
The application uses Stripe for subscription payments with three tiers:
- **Free**: 3 dishes/month (no payment required)
- **Starter**: 30 dishes/month - AED 99/month (`price_1SNlFMFWxz5KcBumZHaSjsqc`)
- **Pro**: 150 dishes/month - AED 299/month (`price_1SNkr2FWxz5KcBumLjab1Cns`)

### Environment Variables

Required in Railway/production:
```bash
STRIPE_SECRET_KEY=sk_test_...              # Stripe secret API key
STRIPE_WEBHOOK_SECRET=whsec_...            # Webhook signing secret
STRIPE_STARTER_PRICE_ID=price_1SNlFMFWxz5KcBumZHaSjsqc
STRIPE_PRO_PRICE_ID=price_1SNkr2FWxz5KcBumLjab1Cns
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_...    # For frontend Stripe Elements
```

### Webhook Configuration

**Webhook URL**: `https://mydscvr-production.up.railway.app/api/stripe/webhook`

**Required Events** (configured via Stripe CLI):
```bash
stripe webhook_endpoints update we_1SNAv3FWxz5KcBumw6SRpIg6 \
  -d "enabled_events[0]=invoice.payment_succeeded" \
  -d "enabled_events[1]=customer.subscription.deleted" \
  -d "enabled_events[2]=customer.subscription.updated"
```

**Event Handlers** (`src/routes.ts:92-292`):

1. **`invoice.payment_succeeded`** (lines 120-204)
   - Triggers on subscription renewals (monthly billing)
   - Creates/updates subscription in database
   - Creates usage record for billing period
   - Requires `billing_reason: "subscription_create" | "subscription_cycle"`
   - Validates subscription has `metadata.userId` and `metadata.tier`

2. **`customer.subscription.updated`** (lines 205-287)
   - Triggers when subscription is created or modified
   - **PRIMARY handler for new subscriptions** (creates if doesn't exist)
   - Updates existing subscriptions (status, period dates)
   - Requires `metadata.userId` and `metadata.tier`

3. **`customer.subscription.deleted`** (lines 205-287)
   - Marks subscription as cancelled in database
   - Updates subscription status to "cancelled"

### Subscription Flow

#### New Subscription Creation

1. **Frontend**: User clicks "Upgrade to Pro"
2. **API**: `POST /api/create-subscription-intent` (lines 417-577)
   - Creates Stripe customer if doesn't exist
   - Creates subscription with `payment_behavior: "default_incomplete"`
   - Sets metadata: `{ userId, tier }`
   - Returns `clientSecret` from `confirmation_secret` (Stripe API Oct 2025 change)
3. **Frontend**: Stripe Elements collects payment
4. **Stripe**: Processes payment
5. **Webhook**: Stripe sends `customer.subscription.updated`
6. **Backend**: Creates subscription + usage record in database
7. **Result**: User sees updated entitlements on dashboard

#### Metadata Requirements

**CRITICAL**: All Stripe subscriptions MUST include metadata:
```typescript
metadata: {
  userId: string,    // User UUID from database
  tier: "starter" | "pro"
}
```

Without this metadata, webhooks will fail silently and subscriptions won't sync to database.

### Database Schema

**subscriptions table**:
```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  tier VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL,
  stripe_customer_id VARCHAR(255),
  stripe_subscription_id VARCHAR(255),
  current_period_start TIMESTAMP,
  current_period_end TIMESTAMP,
  cancel_at_period_end INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**usage_records table**:
```sql
CREATE TABLE usage_records (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  subscription_id UUID REFERENCES subscriptions(id),
  dishes_generated INTEGER DEFAULT 0,
  images_generated INTEGER DEFAULT 0,
  billing_period_start TIMESTAMP,
  billing_period_end TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### Key API Endpoints

- `POST /api/create-subscription-intent` - Create Stripe subscription (returns clientSecret)
- `GET /api/subscriptions/current` - Get user's active subscription
- `POST /api/subscriptions/sync` - Manual sync from Stripe (for debugging)
- `GET /api/usage/current` - Get current billing period usage
- `POST /api/stripe/webhook` - Stripe webhook handler

### Troubleshooting

#### Subscription not syncing to database

1. **Check webhook events**: Ensure all 3 events are configured in Stripe Dashboard
2. **Verify metadata**: Subscription must have `userId` and `tier` in metadata
3. **Check Railway logs**:
   ```bash
   railway logs --service mydscvr
   ```
4. **Check Stripe webhook logs**: Dashboard → Developers → Webhooks → Click endpoint

#### Manual subscription insertion (emergency fix)

If a subscription exists in Stripe but not in database:
```javascript
// Use check-db.js to verify issue
node check-db.js

// Use insert-subscription.js to manually insert
// Update with actual subscription details from Stripe
node insert-subscription.js
```

#### Test webhook locally

```bash
stripe listen --forward-to localhost:5000/api/stripe/webhook
stripe trigger customer.subscription.updated
```

### Recent Changes

**2025-10-30**: Fixed webhook configuration
- Changed from `payment_intent.succeeded` to subscription events
- `customer.subscription.updated` now creates new subscriptions (previously only updated)
- Webhook secret properly configured in Railway: `whsec_i7j6vRoQvABNuEqs2WILsODMTGGzG9nn`

### Stripe API Version

Using Stripe API version `2025-09-30.clover` with October 2025 changes:
- Using `confirmation_secret` instead of `payment_intent` for client_secret
- `expand: ["latest_invoice.confirmation_secret"]` required
